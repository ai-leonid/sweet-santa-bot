# План реализации "Тайный Санта" (Telegram Mini App)

Этот план описывает этапы разработки приложения для проведения жеребьевки "Тайный Санта" в виде Telegram Mini App.

## Фаза 1: Настройка окружения и зависимостей

1.  **Инициализация стека**
    -   [x] Убедиться, что Node.js установлен.
    -   Установить необходимые пакеты:
        -   [x] `prisma` (dev), `@prisma/client`
        -   [x] `shadcn-ui` (init)
        -   [x] `lucide-react` (иконки)
        -   [x] `clsx`, `tailwind-merge` (утилиты для стилей)
        -   [x] `@twa-dev/sdk` (или аналог для работы с Telegram WebApp)
        -   [x] `zod` (валидация)

2.  **Настройка базы данных**
    -   [x] Настроить подключение к PostgreSQL в `.env`.
    -   [x] Инициализировать Prisma: `npx prisma init`.

3.  **Настройка UI**
    -   [x] Инициализировать shadcn/ui.
    -   [x] Добавить базовые компоненты: Button, Input, Card, Dialog, Checkbox, Select, Toast (sonner), Avatar.

## Фаза 2: Проектирование Базы Данных (Prisma Schema)

Необходимо создать следующие модели:

1.  **User (Пользователь Telegram)** [x]
    -   `telegramId` (BigInt/String, уникальный)
    -   `username` (String)
    -   `firstName` (String)
    -   `lastName` (String)
    -   `createdAt`

2.  **Game (Игра/Жеребьевка)** [x]
    -   `id` (UUID)
    -   `title` (String)
    -   `creatorId` (User relation)
    -   `status` (Enum: DRAFT, STARTED, COMPLETED) - *Примечание: STARTED означает жеребьевка проведена*
    -   `inviteCode` (String, уникальный для ссылки)
    -   `createdAt`

3.  **Participant (Участник игры)** [x]
    -   `id` (UUID)
    -   `gameId` (Game relation)
    -   `userId` (User relation, nullable - если null, это оффлайн игрок)
    -   `name` (String - имя отображаемое в игре)
    -   `isOffline` (Boolean)
    -   `giverId` (Participant relation - кто дарит этому участнику, заполняется после жеребьевки)
    -   `receiverId` (Participant relation - кому дарит этот участник, заполняется после жеребьевки)

4.  **Exclusion (Стоп-лист)** [x]
    -   `id` (UUID)
    -   `gameId` (Game relation)
    -   `whoId` (Participant relation - КТО не может дарить)
    -   `whomId` (Participant relation - КОМУ нельзя дарить)
    -   *Constraint: Unique(whoId, whomId)*

## Фаза 3: Бэкенд логика (Server Actions / API)

1.  **Telegram Auth & Middleware**
    -   [x] Реализовать валидацию `initData` от Telegram для безопасности.
    -   [x] Создать функцию `getCurrentUser`, которая создает или находит пользователя в БД при входе.

2.  **Управление игрой**
    -   [x] `createGame(title)`: Создание новой игры.
    -   [x] `joinGame(inviteCode)`: Присоединение текущего пользователя к игре.
    -   [x] `addOfflinePlayer(gameId, name)`: Добавление оффлайн игрока создателем.
    -   [x] `getGameDetails(gameId)`: Получение списка участников и статуса.

3.  **Управление исключениями (Стоп-лист)**
    -   [x] `addExclusion(gameId, whoId, whomId, mutual)`:
        -   Добавляет запись `whoId -> whomId`.
        -   Если `mutual` (взаимоисключение), добавляет также `whomId -> whoId`.
    -   [x] `removeExclusion(exclusionId)`: Удаление правила.

4.  **Жеребьевка (Core Logic)**
    -   [x] `runDraw(gameId)`:
        -   Проверить права (только создатель).
        -   Получить всех участников и все исключения.
        -   Алгоритм: Найти такую перестановку, где каждый дарит ровно одному и получает от ровно одного, и нет нарушений исключений. (Использовать граф или бэктрекинг с рандомизацией).
        -   Сохранить результаты в БД (обновить поля `receiverId` у участников).
        -   Сменить статус игры на `STARTED`.

## Фаза 4: Фронтенд (Интерфейс)

1.  **Layout & Providers**
    -   Обертка для инициализации Telegram WebApp.
    -   React Query или просто `useEffect` для загрузки данных.

2.  **Главная страница (Home)**
    -   Список активных игр пользователя.
    -   Кнопка "Создать новую игру".
    -   Обработка deep-link параметров (если перешли по ссылке-приглашению, сразу предлагать вступить).

3.  **Страница игры (Lobby)**
    -   Заголовок игры.
    -   Список участников (разделение на "В сети" и "Оффлайн").
    -   **Для создателя**:
        -   Кнопка "Добавить оффлайн участника".
        -   Кнопка настройки (шестеренка) напротив каждого участника -> Открывает модал Стоп-листа.
        -   Кнопка "Начать жеребьевку" (если участников > 2).
    -   **Для обычного участника**:
        -   Видит список, ждет начала.
    -   **После жеребьевки**:
        -   Кнопка "Посмотреть результат" (для себя).
        -   Если создатель: Кнопка "Результат оффлайн игроков".

4.  **Модалка Стоп-листа**
    -   Выбор "Кому не может дарить {Имя}".
    -   Чекбокс "Взаимоисключение".
    -   Список текущих ограничений с кнопкой удалить.

5.  **Просмотр результатов**
    -   **Личный**: Карточка с текстом "Ты даришь подарок..." и спойлер (компонент, скрывающий текст до клика).
    -   **Оффлайн**: Список оффлайн игроков. Клик по игроку -> открывается его результат под спойлером.

## Фаза 5: Развертывание и Тестирование

1.  **Telegram Bot Setup**
    -   Настроить бота в BotFather.
    -   Установить Menu Button типа Web App, ведущую на URL деплоя.
2.  **Тестирование сценариев**
    -   Создание игры.
    -   Приглашение друга (через `tg://resolve...startapp=...`).
    -   Настройка исключений.
    -   Проведение жеребьевки.
    -   Проверка результатов (онлайн и оффлайн).

## Технические заметки

-   **Tailwind**: Использовать для верстки.
-   **Shadcn/UI**: Использовать компоненты `Card`, `Button`, `Dialog`, `ScrollArea`.
-   **Prisma**: Использовать транзакции при сохранении результатов жеребьевки для целостности.
-   **Deep Linking**: Telegram Mini Apps передают `start_param` в `initDataUnsafe`. Использовать его для инвайтов.

